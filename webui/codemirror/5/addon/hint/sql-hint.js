// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE
(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../../mode/sql/sql")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],e):e(CodeMirror)})(function(e){"use strict";function o(t){var n=t.doc.modeOption;return n==="sql"&&(n="text/x-sql"),e.resolveMode(n).keywords}function u(e){return typeof e=="string"?e:e.text}function a(e,t){if(!e.slice)return e[t];for(var n=e.length-1;n>=0;n--)if(u(e[n])==t)return e[n]}function f(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function l(e,t){var n=e.length,r=u(t).substr(0,n);return e.toUpperCase()===r.toUpperCase()}function c(e,t,n,r){for(var i in n){if(!n.hasOwnProperty(i))continue;n.slice&&(i=n[i]),l(t,i)&&e.push(r(i))}}function h(e){return e.charAt(0)=="."&&(e=e.substr(1)),e.replace(/`/g,"")}function p(e){var t=u(e).split(".");for(var n=0;n<t.length;n++)t[n]="`"+t[n]+"`";var r=t.join(".");return typeof e=="string"?r:(e=f(e),e.text=r,e)}function d(e,r,i,o){var u=!1,l=[],d=r.start,v=!0;while(v)v=r.string.charAt(0)==".",u=u||r.string.charAt(0)=="`",d=r.start,l.unshift(h(r.string)),r=o.getTokenAt(s(e.line,r.start)),r.string=="."&&(v=!0,r=o.getTokenAt(s(e.line,r.start)));var m=l.join(".");c(i,m,t,function(e){return u?p(e):e}),c(i,m,n,function(e){return u?p(e):e}),m=l.pop();var g=l.join("."),b=!1,w=g;if(!a(t,g)){var E=g;g=y(g,o),g!==E&&(b=!0)}var S=a(t,g);return S&&S.columns&&(S=S.columns),S&&c(i,m,S,function(e){var t=g;return b==1&&(t=w),typeof e=="string"?e=t+"."+e:(e=f(e),e.text=t+"."+e.text),u?p(e):e}),d}function v(e,t){if(!e)return;var n=/[,;]/g,r=e.split(" ");for(var i=0;i<r.length;i++)t(r[i]?r[i].replace(n,""):"")}function m(e){return e.line+e.ch/Math.pow(10,6)}function g(e){return s(Math.floor(e),+e.toString().split(".").pop())}function y(e,n){var r=n.doc,o=r.getValue(),u=e.toUpperCase(),f="",l="",c=[],h={start:s(0,0),end:s(n.lastLine(),n.getLineHandle(n.lastLine()).length)},p=o.indexOf(i.QUERY_DIV);while(p!=-1)c.push(r.posFromIndex(p)),p=o.indexOf(i.QUERY_DIV,p+1);c.unshift(s(0,0)),c.push(s(n.lastLine(),n.getLineHandle(n.lastLine()).text.length));var d=0,y=m(n.getCursor());for(var b=0;b<c.length;b++){var w=m(c[b]);if(y>d&&y<=w){h={start:g(d),end:g(w)};break}d=w}var E=r.getRange(h.start,h.end,!1);for(var b=0;b<E.length;b++){var S=E[b];v(S,function(e){var n=e.toUpperCase();n===u&&a(t,f)&&(l=f),n!==i.ALIAS_KEYWORD&&(f=e)});if(l)break}return l}var t,n,r,i={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},s=e.Pos;e.registerHelper("hint","sql",function(e,i){t=i&&i.tables||{};var u=i&&i.defaultTable,f=i&&i.disableKeywords;n=u&&a(t,u),r=r||o(e),u&&!n&&(n=y(u,e)),n=n||[],n.columns&&(n=n.columns);var l=e.getCursor(),h=[],p=e.getTokenAt(l),v,m,g;return p.end>l.ch&&(p.end=l.ch,p.string=p.string.slice(0,l.ch-p.start)),p.string.match(/^[.`\w@]\w*$/)?(g=p.string,v=p.start,m=p.end):(v=m=l.ch,g=""),g.charAt(0)=="."||g.charAt(0)=="`"?v=d(l,p,h,e):(c(h,g,t,function(e){return e}),c(h,g,n,function(e){return e}),f||c(h,g,r,function(e){return e.toUpperCase()})),{list:h,from:s(l.line,v),to:s(l.line,m)}})});