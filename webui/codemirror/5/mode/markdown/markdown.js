// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE
(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../xml/xml"),require("../meta")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../xml/xml","../meta"],e):e(CodeMirror)})(function(e){"use strict";e.defineMode("markdown",function(t,n){function s(n){if(e.findModeByName){var r=e.findModeByName(n);r&&(n=r.mime||r.mimes[0])}var i=e.getMode(t,n);return i.name=="null"?null:i}function g(e,t,n){return t.f=t.inline=n,n(e,t)}function y(e,t,n){return t.f=t.block=n,n(e,t)}function b(e){return!e||!/\S/.test(e.string)}function w(e){return e.linkTitle=!1,e.em=!1,e.strong=!1,e.strikethrough=!1,e.quote=0,e.indentedCode=!1,!r&&e.f==S&&(e.f=k,e.block=E),e.trailingSpace=0,e.trailingSpaceNewLine=!1,e.prevLine=e.thisLine,e.thisLine=null,null}function E(e,t){var r=e.sol(),i=t.list!==!1,o=t.indentedCode;t.indentedCode=!1,i&&(t.indentationDiff>=0?(t.indentationDiff<4&&(t.indentation-=t.indentationDiff),t.list=null):t.indentation>0?(t.list=null,t.listDepth=Math.floor(t.indentation/4)):(t.list=!1,t.listDepth=0));var a=null;if(t.indentationDiff>=4)return e.skipToEnd(),o||b(t.prevLine)?(t.indentation-=4,t.indentedCode=!0,u.code):null;if(e.eatSpace())return null;if((a=e.match(p))&&a[1].length<=6)return t.header=a[1].length,n.highlightFormatting&&(t.formatting="header"),t.f=t.inline,N(t);if(!b(t.prevLine)&&!t.quote&&!i&&!o&&(a=e.match(d)))return t.header=a[0].charAt(0)=="="?1:2,n.highlightFormatting&&(t.formatting="header"),t.f=t.inline,N(t);if(e.eat(">"))return t.quote=r?1:t.quote+1,n.highlightFormatting&&(t.formatting="quote"),e.eatSpace(),N(t);if(e.peek()==="[")return g(e,t,M);if(e.match(f,!0))return t.hr=!0,u.hr;if((b(t.prevLine)||i)&&(e.match(l,!1)||e.match(c,!1))){var v=null;return e.match(l,!0)?v="ul":(e.match(c,!0),v="ol"),t.indentation=e.column()+e.current().length,t.list=!0,t.listDepth++,n.taskLists&&e.match(h,!1)&&(t.taskList=!0),t.f=t.inline,n.highlightFormatting&&(t.formatting=["list","list-"+v]),N(t)}return n.fencedCodeBlocks&&(a=e.match(m,!0))?(t.fencedChars=a[1],t.localMode=s(a[2]),t.localMode&&(t.localState=t.localMode.startState()),t.f=t.block=x,n.highlightFormatting&&(t.formatting="code-block"),t.code=!0,N(t)):g(e,t,t.inline)}function S(e,t){var n=i.token(e,t.htmlState);if(r&&t.htmlState.tagStart===null&&!t.htmlState.context&&t.htmlState.tokenize.isInText||t.md_inside&&e.current().indexOf(">")>-1)t.f=k,t.block=E,t.htmlState=null;return n}function x(e,t){return e.sol()&&t.fencedChars&&e.match(t.fencedChars,!1)?(t.localMode=t.localState=null,t.f=t.block=T,null):t.localMode?t.localMode.token(e,t.localState):(e.skipToEnd(),u.code)}function T(e,t){e.match(t.fencedChars),t.block=E,t.f=k,t.fencedChars=null,n.highlightFormatting&&(t.formatting="code-block"),t.code=!0;var r=N(t);return t.code=!1,r}function N(e){var t=[];if(e.formatting){t.push(u.formatting),typeof e.formatting=="string"&&(e.formatting=[e.formatting]);for(var r=0;r<e.formatting.length;r++)t.push(u.formatting+"-"+e.formatting[r]),e.formatting[r]==="header"&&t.push(u.formatting+"-"+e.formatting[r]+"-"+e.header),e.formatting[r]==="quote"&&(!n.maxBlockquoteDepth||n.maxBlockquoteDepth>=e.quote?t.push(u.formatting+"-"+e.formatting[r]+"-"+e.quote):t.push("error"))}if(e.taskOpen)return t.push("meta"),t.length?t.join(" "):null;if(e.taskClosed)return t.push("property"),t.length?t.join(" "):null;e.linkHref?t.push(u.linkHref,"url"):(e.strong&&t.push(u.strong),e.em&&t.push(u.em),e.strikethrough&&t.push(u.strikethrough),e.linkText&&t.push(u.linkText),e.code&&t.push(u.code)),e.header&&t.push(u.header,u.header+"-"+e.header),e.quote&&(t.push(u.quote),!n.maxBlockquoteDepth||n.maxBlockquoteDepth>=e.quote?t.push(u.quote+"-"+e.quote):t.push(u.quote+"-"+n.maxBlockquoteDepth));if(e.list!==!1){var i=(e.listDepth-1)%3;i?i===1?t.push(u.list2):t.push(u.list3):t.push(u.list1)}return e.trailingSpaceNewLine?t.push("trailing-space-new-line"):e.trailingSpace&&t.push("trailing-space-"+(e.trailingSpace%2?"a":"b")),t.length?t.join(" "):null}function C(e,t){return e.match(v,!0)?N(t):undefined}function k(t,r){var s=r.text(t,r);if(typeof s!="undefined")return s;if(r.list)return r.list=null,N(r);if(r.taskList){var a=t.match(h,!0)[1]!=="x";return a?r.taskOpen=!0:r.taskClosed=!0,n.highlightFormatting&&(r.formatting="task"),r.taskList=!1,N(r)}r.taskOpen=!1,r.taskClosed=!1;if(r.header&&t.match(/^#+$/,!0))return n.highlightFormatting&&(r.formatting="header"),N(r);var f=t.sol(),l=t.next();if(l==="\\"){t.next();if(n.highlightFormatting){var c=N(r),p=u.formatting+"-escape";return c?c+" "+p:p}}if(r.linkTitle){r.linkTitle=!1;var d=l;l==="("&&(d=")"),d=(d+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var v="^\\s*(?:[^"+d+"\\\\]+|\\\\\\\\|\\\\.)"+d;if(t.match(new RegExp(v),!0))return u.linkHref}if(l==="`"){var m=r.formatting;n.highlightFormatting&&(r.formatting="code");var g=N(r),b=t.pos;t.eatWhile("`");var w=1+t.pos-b;return r.code?w===o?(r.code=!1,g):(r.formatting=m,N(r)):(o=w,r.code=!0,N(r))}if(r.code)return N(r);if(l==="!"&&t.match(/\[[^\]]*\] ?(?:\(|\[)/,!1))return t.match(/\[[^\]]*\]/),r.inline=r.f=A,u.image;if(l==="["&&t.match(/.*\](\(.*\)| ?\[.*\])/,!1))return r.linkText=!0,n.highlightFormatting&&(r.formatting="link"),N(r);if(l==="]"&&r.linkText&&t.match(/\(.*\)| ?\[.*\]/,!1)){n.highlightFormatting&&(r.formatting="link");var c=N(r);return r.linkText=!1,r.inline=r.f=A,c}if(l==="<"&&t.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,!1)){r.f=r.inline=L,n.highlightFormatting&&(r.formatting="link");var c=N(r);return c?c+=" ":c="",c+u.linkInline}if(l==="<"&&t.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,!1)){r.f=r.inline=L,n.highlightFormatting&&(r.formatting="link");var c=N(r);return c?c+=" ":c="",c+u.linkEmail}if(l==="<"&&t.match(/^(!--|\w)/,!1)){var E=t.string.indexOf(">",t.pos);if(E!=-1){var x=t.string.substring(t.start,E);/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(x)&&(r.md_inside=!0)}return t.backUp(1),r.htmlState=e.startState(i),y(t,r,S)}if(l==="<"&&t.match(/^\/\w*?>/))return r.md_inside=!1,"tag";var T=!1;if(!n.underscoresBreakWords&&l==="_"&&t.peek()!=="_"&&t.match(/(\w)/,!1)){var C=t.pos-2;if(C>=0){var k=t.string.charAt(C);k!=="_"&&k.match(/(\w)/,!1)&&(T=!0)}}if(l==="*"||l==="_"&&!T){if(!f||t.peek()!==" "){if(r.strong===l&&t.eat(l)){n.highlightFormatting&&(r.formatting="strong");var g=N(r);return r.strong=!1,g}if(!r.strong&&t.eat(l))return r.strong=l,n.highlightFormatting&&(r.formatting="strong"),N(r);if(r.em===l){n.highlightFormatting&&(r.formatting="em");var g=N(r);return r.em=!1,g}if(!r.em)return r.em=l,n.highlightFormatting&&(r.formatting="em"),N(r)}}else if(l===" ")if(t.eat("*")||t.eat("_")){if(t.peek()===" ")return N(r);t.backUp(1)}if(n.strikethrough)if(l==="~"&&t.eatWhile(l)){if(r.strikethrough){n.highlightFormatting&&(r.formatting="strikethrough");var g=N(r);return r.strikethrough=!1,g}if(t.match(/^[^\s]/,!1))return r.strikethrough=!0,n.highlightFormatting&&(r.formatting="strikethrough"),N(r)}else if(l===" "&&t.match(/^~~/,!0)){if(t.peek()===" ")return N(r);t.backUp(2)}return l===" "&&(t.match(/ +$/,!1)?r.trailingSpace++:r.trailingSpace&&(r.trailingSpaceNewLine=!0)),N(r)}function L(e,t){var r=e.next();if(r===">"){t.f=t.inline=k,n.highlightFormatting&&(t.formatting="link");var i=N(t);return i?i+=" ":i="",i+u.linkInline}return e.match(/^[^>]+/,!0),u.linkInline}function A(e,t){if(e.eatSpace())return null;var r=e.next();return r==="("||r==="["?(t.f=t.inline=O(r==="("?")":"]"),n.highlightFormatting&&(t.formatting="link-string"),t.linkHref=!0,N(t)):"error"}function O(e){return function(t,r){var i=t.next();if(i===e){r.f=r.inline=k,n.highlightFormatting&&(r.formatting="link-string");var s=N(r);return r.linkHref=!1,s}return t.match(H(e),!0)&&t.backUp(1),r.linkHref=!0,N(r)}}function M(e,t){return e.match(/^[^\]]*\]:/,!1)?(t.f=_,e.next(),n.highlightFormatting&&(t.formatting="link"),t.linkText=!0,N(t)):g(e,t,k)}function _(e,t){if(e.match(/^\]:/,!0)){t.f=t.inline=D,n.highlightFormatting&&(t.formatting="link");var r=N(t);return t.linkText=!1,r}return e.match(/^[^\]]+/,!0),u.linkText}function D(e,t){return e.eatSpace()?null:(e.match(/^[^\s]+/,!0),e.peek()===undefined?t.linkTitle=!0:e.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,!0),t.f=t.inline=k,u.linkHref+" url")}function H(e){return P[e]||(e=(e+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),P[e]=new RegExp("^(?:[^\\\\]|\\\\.)*?("+e+")")),P[e]}var r=e.modes.hasOwnProperty("xml"),i=e.getMode(t,r?{name:"xml",htmlMode:!0}:"text/plain");n.highlightFormatting===undefined&&(n.highlightFormatting=!1),n.maxBlockquoteDepth===undefined&&(n.maxBlockquoteDepth=0),n.underscoresBreakWords===undefined&&(n.underscoresBreakWords=!0),n.taskLists===undefined&&(n.taskLists=!1),n.strikethrough===undefined&&(n.strikethrough=!1),n.tokenTypeOverrides===undefined&&(n.tokenTypeOverrides={});var o=0,u={header:"header",code:"comment",quote:"quote",list1:"variable-2",list2:"variable-3",list3:"keyword",hr:"hr",image:"tag",formatting:"formatting",linkInline:"link",linkEmail:"link",linkText:"link",linkHref:"string",em:"em",strong:"strong",strikethrough:"strikethrough"};for(var a in u)u.hasOwnProperty(a)&&n.tokenTypeOverrides[a]&&(u[a]=n.tokenTypeOverrides[a]);var f=/^([*\-_])(?:\s*\1){2,}\s*$/,l=/^[*\-+]\s+/,c=/^[0-9]+([.)])\s+/,h=/^\[(x| )\](?=\s)/,p=n.allowAtxHeaderWithoutSpace?/^(#+)/:/^(#+)(?: |$)/,d=/^ *(?:\={1,}|-{1,})\s*$/,v=/^[^#!\[\]*_\\<>` "'(~]+/,m=new RegExp("^("+(n.fencedCodeBlocks===!0?"~~~+|```+":n.fencedCodeBlocks)+")[ \\t]*([\\w+#]*)"),P=[],B={startState:function(){return{f:E,prevLine:null,thisLine:null,block:E,htmlState:null,indentation:0,inline:k,text:C,formatting:!1,linkText:!1,linkHref:!1,linkTitle:!1,em:!1,strong:!1,header:0,hr:!1,taskList:!1,list:!1,listDepth:0,quote:0,trailingSpace:0,trailingSpaceNewLine:!1,strikethrough:!1,fencedChars:null}},copyState:function(t){return{f:t.f,prevLine:t.prevLine,thisLine:t.this,block:t.block,htmlState:t.htmlState&&e.copyState(i,t.htmlState),indentation:t.indentation,localMode:t.localMode,localState:t.localMode?e.copyState(t.localMode,t.localState):null,inline:t.inline,text:t.text,formatting:!1,linkTitle:t.linkTitle,code:t.code,em:t.em,strong:t.strong,strikethrough:t.strikethrough,header:t.header,hr:t.hr,taskList:t.taskList,list:t.list,listDepth:t.listDepth,quote:t.quote,indentedCode:t.indentedCode,trailingSpace:t.trailingSpace,trailingSpaceNewLine:t.trailingSpaceNewLine,md_inside:t.md_inside,fencedChars:t.fencedChars}},token:function(e,t){t.formatting=!1;if(e!=t.thisLine){var n=t.header||t.hr;t.header=0,t.hr=!1;if(e.match(/^\s*$/,!0)||n){w(t);if(!n)return null;t.prevLine=null}t.prevLine=t.thisLine,t.thisLine=e,t.taskList=!1,t.trailingSpace=0,t.trailingSpaceNewLine=!1,t.f=t.block;var r=e.match(/^\s*/,!0)[0].replace(/\t/g,"    ").length,i=Math.floor((r-t.indentation)/4)*4;i>4&&(i=4);var s=t.indentation+i;t.indentationDiff=s-t.indentation,t.indentation=s;if(r>0)return null}return t.f(e,t)},innerMode:function(e){return e.block==S?{state:e.htmlState,mode:i}:e.localState?{state:e.localState,mode:e.localMode}:{state:e,mode:B}},blankLine:w,getType:N,fold:"markdown"};return B},"xml"),e.defineMIME("text/x-markdown","markdown")});